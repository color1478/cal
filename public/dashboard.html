<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 30px;
    }

    h1 {
      text-align: center;
      margin-bottom: 40px;
    }

    .stats {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 20px;
      width: 220px;
      text-align: center;
    }

    .card h2 {
      margin: 0;
      font-size: 2em;
      color: #007bff;
    }

    .card p {
      margin-top: 8px;
      color: #555;
    }

    h3 {
      margin-top: 40px;
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }

    ul {
      list-style: none;
      padding-left: 0;
    }

    ul li {
      background: white;
      margin: 5px 0;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š ì£¼ë¬¸ ëŒ€ì‹œë³´ë“œ</h1>

  <div class="stats">
    <div class="card"><h2 id="totalOrders">0</h2><p>ì´ ì£¼ë¬¸ ìˆ˜</p></div>
    <div class="card"><h2 id="totalRevenue">0ì›</h2><p>ì´ íŒë§¤ ê¸ˆì•¡</p></div>
    <div class="card"><h2 id="studentRevenue">0ì›</h2><p>ì´í•™ ë¬¼í’ˆ ë§¤ì¶œ</p></div>
    <div class="card"><h2 id="creatorRevenue">0ì›</h2><p>ì›ì‘ì ë¬¼í’ˆ ë§¤ì¶œ</p></div>
    <div class="card"><h2 id="externalCount">0</h2><p>ì™¸ë¶€ì¸ ì£¼ë¬¸</p></div>
    <div class="card"><h2 id="paidCount">0</h2><p>ë‚©ë¶€ì ì£¼ë¬¸</p></div>
    <div class="card"><h2 id="unpaidCount">0</h2><p>ë¯¸ë‚©ë¶€ì ì£¼ë¬¸</p></div>
    <div class="card"><h2 id="genderRatio">-</h2><p>ë‚¨/ì—¬ ì„±ë¹„</p></div>
  </div>

  <h3>ğŸ“¦ ìƒí’ˆë³„ íŒë§¤ ìˆ˜ëŸ‰</h3>
  <ul id="productSales"></ul>

  <h3>ğŸ“ í•™ê³¼ë³„ ì£¼ë¬¸ ë¹„ìœ¨</h3>
  <ul id="departmentStats"></ul>

    <h2>ğŸ“… ë‚ ì§œë³„ ì£¼ë¬¸ í†µê³„</h2>
    <table id="dailyStatsTable" border="1" cellspacing="0" cellpadding="8">
    <thead>
        <tr>
        <th>ë‚ ì§œ</th>
        <th>ì´ ì£¼ë¬¸ ìˆ˜</th>
        <th>ì´ ê¸ˆì•¡ (ì›)</th>
        </tr>
    </thead>
    <tbody></tbody>
    </table>

  <script>
    async function loadDashboard() {
      const res = await fetch('/api/orders');
      const orders = await res.json();
      const stats = getSummaryStats(orders);
      displayStats(stats);
    }

    function getSummaryStats(orders) {
      const stats = {
        totalOrders: orders.length,
        totalRevenue: 0,
        productSales: {},
        studentRevenue: 0,
        creatorRevenue: 0,
        external: 0,
        paid: 0,
        unpaid: 0,
        gender: { ë‚¨: 0, ì—¬: 0 },
        departments: {}
      };

      for (const order of orders) {
        stats.totalRevenue += order.totalPrice || 0;

        // ì‚¬ìš©ì ìœ í˜•
        if (order.payment === "ì™¸ë¶€ì¸" || order.studentId === "ì™¸ë¶€ì¸") stats.external++;
        else if (order.payment === true) stats.paid++;
        else if (order.payment === false) stats.unpaid++;

        // ì„±ë³„
        if (order.gender === "ë‚¨") stats.gender.ë‚¨++;
        if (order.gender === "ì—¬") stats.gender.ì—¬++;

        // í•™ê³¼
        const dept = order.í•™ê³¼ || "ê¸°íƒ€";
        stats.departments[dept] = (stats.departments[dept] || 0) + 1;

        // ìƒí’ˆ
        for (const item of order.items || []) {
          stats.productSales[item.name] = (stats.productSales[item.name] || 0) + item.count;

          if (item.category === "ì´í•™ ë¬¼í’ˆ")
            stats.studentRevenue += item.count * item.unitPrice;
          else if (item.category === "ì›ì‘ì ë¬¼í’ˆ")
            stats.creatorRevenue += item.count * item.unitPrice;
        }
      }

      return stats;
    }

    function displayStats(stats) {
      document.getElementById("totalOrders").textContent = stats.totalOrders;
      document.getElementById("totalRevenue").textContent = stats.totalRevenue.toLocaleString() + "ì›";
      document.getElementById("studentRevenue").textContent = stats.studentRevenue.toLocaleString() + "ì›";
      document.getElementById("creatorRevenue").textContent = stats.creatorRevenue.toLocaleString() + "ì›";
      document.getElementById("externalCount").textContent = stats.external;
      document.getElementById("paidCount").textContent = stats.paid;
      document.getElementById("unpaidCount").textContent = stats.unpaid;

      const ë‚¨ = stats.gender.ë‚¨;
      const ì—¬ = stats.gender.ì—¬;
      document.getElementById("genderRatio").textContent = `${ë‚¨} : ${ì—¬}`;

      // ìƒí’ˆë³„ íŒë§¤ ìˆ˜ëŸ‰
      const prodList = document.getElementById("productSales");
      prodList.innerHTML = "";
      for (const [name, count] of Object.entries(stats.productSales)) {
        const li = document.createElement("li");
        li.textContent = `${name}: ${count}ê°œ`;
        prodList.appendChild(li);
      }

      // í•™ê³¼ ë¹„ìœ¨
      const deptList = document.getElementById("departmentStats");
      deptList.innerHTML = "";
      for (const [dept, count] of Object.entries(stats.departments)) {
        const li = document.createElement("li");
        li.textContent = `${dept}: ${count}ëª…`;
        deptList.appendChild(li);
      }
    }

    async function loadDailyStats() {
    const res = await fetch("/api/orders");
    const orders = await res.json();

    const dateMap = {};

    orders.forEach(order => {
        if (!order.timestamp) return;

        const date = new Date(order.timestamp).toISOString().split("T")[0];
        if (!dateMap[date]) {
        dateMap[date] = { count: 0, total: 0 };
        }
        dateMap[date].count += 1;
        dateMap[date].total += order.totalPrice || 0;
    });

    const sortedDates = Object.keys(dateMap).sort();
    const tbody = document.querySelector("#dailyStatsTable tbody");
    tbody.innerHTML = "";

    sortedDates.forEach(date => {
        const row = document.createElement("tr");
        row.innerHTML = `
        <td>${date}</td>
        <td>${dateMap[date].count}</td>
        <td>${dateMap[date].total.toLocaleString()}ì›</td>
        `;
        tbody.appendChild(row);
    });
    }

    // âœ… í˜¸ì¶œì€ ìµœí•˜ë‹¨ì—ì„œ ê°ê°
    loadDashboard();
    loadDailyStats();

  </script>
</body>
</html>
