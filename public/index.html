<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìƒí’ˆ ê³„ì‚°ê¸°</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="navigation-buttons">
    <a href="orders.html"><button type="button">ğŸ“¦ ì£¼ë¬¸ ë‚´ì—­ ë³´ê¸°</button></a>
    <a href="dashboard.html"><button type="button">ğŸ“Š ëŒ€ì‹œë³´ë“œ ë³´ê¸°</button></a>
  </div>

  <h1>ì£¼ë¬¸ ê³„ì‚°ê¸°</h1>

  <form id="orderForm">
    <!-- í•™ë²ˆ + ì™¸ë¶€ì¸ ì²´í¬ + ë²„íŠ¼ -->
    <div class="form-row row-align">
      <label>í•™ë²ˆ: <input id="studentIdInput" name="studentId" type="text" /></label>
      <label><input type="checkbox" id="externalCheck" onchange="handleExternal()" /> ì™¸ë¶€ì¸</label>
      <button type="button" onclick="fetchStudent()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <!-- 5ê°œ í•„ë“œ: ì´ë¦„, í•™ê³¼, ì„±ë³„, ë‚©ë¶€ì ì—¬ë¶€, ìƒíƒœ -->
    <div class="form-grid">
      <label>ì´ë¦„: <input id="name" name="name" type="text" /></label>
      <label>í•™ê³¼: <input id="department" name="department" type="text" /></label>
      <label>ì„±ë³„:
        <select id="gender" name="gender">
          <option value="ë‚¨">ë‚¨</option>
          <option value="ì—¬">ì—¬</option>
        </select>
      </label>
      <label>ë‚©ë¶€ì ì—¬ë¶€:
        <select id="payment" name="payment">
          <option value="true">ë‚©ë¶€ì</option>
          <option value="false">ë¯¸ë‚©ë¶€ì</option>
        </select>
      </label>
      <label>ìƒíƒœ: <input id="status" name="status" type="text" /></label>
    </div>

    <!-- ìƒí’ˆ ì„ íƒ -->
    <div class="product-grid" id="products"></div>

    <!-- ì´ ê°€ê²© -->
    <h3>ì´ ê°€ê²©: <span id="totalPrice">0</span> ì›</h3>
    <p id="acrylicEventTotal" class="event-counter">ëˆ„ì  ì´ë²¤íŠ¸ ìˆ˜ëŸ‰: ê³„ì‚° ì¤‘...</p>
    <button type="submit">ì œì¶œ</button>
    <button type="button" onclick="resetForm()">ì´ˆê¸°í™”</button>
  </form>

  <script src="script.js"></script>
</body>


  <script>
    // ìƒí’ˆ ëª©ë¡ ì •ì˜
    const PRODUCTS = [
    { name: "ì•¼êµ¬ ìœ ë‹ˆí¼ (HOME)", image: "./img/1.png", pricePaid: 39000, priceUnpaid: 42000, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ì•¼êµ¬ ìœ ë‹ˆí¼ (AWAY)", image: "./img/2.png", pricePaid: 39000, priceUnpaid: 42000, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ì•„ì´ìŠ¤í•˜í‚¤ ìœ ë‹ˆí¼ (HOME)", image: "./img/3.png", pricePaid: 40000, priceUnpaid: 43000, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ì•„ì´ìŠ¤í•˜í‚¤ ìœ ë‹ˆí¼ (AWAY)", image: "./img/4.png", pricePaid: 40000, priceUnpaid: 43000, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ë°˜íŒ” í‹°ì…”ì¸  1", image: "./img/5.png", pricePaid: 12000, priceUnpaid: 14000, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ë°˜íŒ” í‹°ì…”ì¸  2", image: "./img/6.png", pricePaid: 12000, priceUnpaid: 14000, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ë°˜íŒ” í‹°ì…”ì¸  3", image: "./img/7.png", pricePaid: 12000, priceUnpaid: 14000, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ë°˜íŒ” í‹°ì…”ì¸  4", image: "./img/8.png", pricePaid: 12000, priceUnpaid: 14000, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ìŠ¬ë¡œê±´ íƒ€ì˜¬", image: "./img/9.png", pricePaid: 6000, priceUnpaid: 7500, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ë°˜ë‹¤ë‚˜", image: "./img/10.png", pricePaid: 5500, priceUnpaid: 7000, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ì›í˜• ë¶€ì±„", image: "./img/11.png", pricePaid: 0, priceUnpaid: 1500, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ì§ìƒ‰ ìš°ë‹ˆ", image: "./img/12.png", pricePaid: 12000, priceUnpaid: 14000, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ì§ìƒ‰ ë¡œê³ ", image: "./img/13.png", pricePaid: 12000, priceUnpaid: 14000, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ì¼íšŒìš© í•„ë¦„ ì¹´ë©”ë¼", image: "./img/14.png", pricePaid: 26000, priceUnpaid: 29000, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ì•„í¬ë¦´ í‚¤ë§ í¼ì¦", image: "./img/15.png", pricePaid: 3000, priceUnpaid: 4500, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ì•„í¬ë¦´ í‚¤ë§ ì•¼êµ¬", image: "./img/16.png", pricePaid: 3000, priceUnpaid: 4500, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ì•„í¬ë¦´ í‚¤ë§ í¼ì¦ (ì´ë²¤íŠ¸)", image: "./img/15event.png", pricePaid: 0, priceUnpaid: 0, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ì•„í¬ë¦´ í‚¤ë§ ì•¼êµ¬ (ì´ë²¤íŠ¸)", image: "./img/16event.png", pricePaid: 0, priceUnpaid: 0, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ìŠ¤í‹°ì»¤ (6ì¢…)", image: "./img/17.png", pricePaid: 300, priceUnpaid: 500, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ìŠ¤í¬ëŸ°ì¹˜", image: "./img/ìŠ¤í¬ëŸ°ì¹˜.jpg", pricePaid: 3500, priceUnpaid: 5500, category: "ì´í•™ ë¬¼í’ˆ" },
    { name: "ì—½ì„œ (4ì¢…)", image: "./img/18.png", pricePaid: 1500, priceUnpaid: 1500, category: "ì›ì‘ì ë¬¼í’ˆ" },
    { name: "íŒìŠ¤í‹°ì»¤ (20pcs)", image: "./img/19.png", pricePaid: 3000, priceUnpaid: 3000, category: "ì›ì‘ì ë¬¼í’ˆ" },
    { name: "ë‚ ì¥ ìŠ¤í‹°ì»¤", image: "./img/20.png", pricePaid: 1000, priceUnpaid: 1000, category: "ì›ì‘ì ë¬¼í’ˆ" },
    { name: "ë±ƒì§€", image: "./img/21.png", pricePaid: 4500, priceUnpaid: 4500, category: "ì›ì‘ì ë¬¼í’ˆ" },
    { name: "ë–¡ë©”ëª¨ì§€", image: "./img/22.png", pricePaid: 2000, priceUnpaid: 2000, category: "ì›ì‘ì ë¬¼í’ˆ" }
    ];

    const productContainer = document.getElementById("products");
    const totalPriceEl = document.getElementById("totalPrice");

    // ìƒí’ˆ í•„ë“œ ì¶”ê°€
    PRODUCTS.forEach((product, index) => {
    const div = document.createElement("div");
    div.className = "product-card";

    // ì´ë²¤íŠ¸ ë²„íŠ¼ ì—¬ë¶€ (ì•„í¬ë¦´ í‚¤ë§ì—ë§Œ)
    const isEventTarget = product.name.includes("ì•„í¬ë¦´ í‚¤ë§");
    const eventButtonHTML = isEventTarget
        ? ``
        : "";

    div.innerHTML = `
        <img src="${product.image}" alt="${product.name}" />
        <p>${product.name} (${product.category})</p>
        <input type="number" name="product${index}" data-index="${index}" min="0" value="0" />
        ${eventButtonHTML}
    `;

    document.getElementById("products").appendChild(div);
    });

    function applyEvent(index) {
    PRODUCTS[index].pricePaid = 0;
    PRODUCTS[index].priceUnpaid = 0;

    alert(`${PRODUCTS[index].name} ê°€ê²©ì´ 0ì›ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    calculateTotal();
    }


    function calculateTotal() {
    const formData = new FormData(document.getElementById("orderForm"));
    const isPaid = formData.get("payment") === "true";
    let total = 0;
    let acrylicEventCount = 0; // âœ… ì´ë²¤íŠ¸ ì ìš©ëœ ì•„í¬ë¦´ í‚¤ë§ ê°œìˆ˜

    PRODUCTS.forEach((product, index) => {
        const count = parseInt(formData.get(`product${index}`)) || 0;
        const unitPrice = isPaid ? product.pricePaid : product.priceUnpaid;

        // ì´ë²¤íŠ¸ ì ìš©ëœ ê²½ìš°: ê°€ê²©ì´ 0ì´ê³  ì´ë¦„ì— 'ì•„í¬ë¦´ í‚¤ë§' í¬í•¨
        if (unitPrice === 0 && product.name.includes("ì•„í¬ë¦´ í‚¤ë§")) {
        acrylicEventCount += count;
        }

        total += count * unitPrice;
    });

    // ì´ ê°€ê²© ì—…ë°ì´íŠ¸
    totalPriceEl.textContent = total.toLocaleString();
    totalPriceEl.dataset.raw = total;

    // âœ… ì´ë²¤íŠ¸ ê°œìˆ˜ ì¶œë ¥ ìœ„ì¹˜ê°€ ìˆë‹¤ë©´ ì—…ë°ì´íŠ¸
    const eventCountEl = document.getElementById("acrylicEventCount");
    if (eventCountEl) {
        eventCountEl.textContent = `ì•„í¬ë¦´ í‚¤ë§ (ì´ë²¤íŠ¸): ${acrylicEventCount}ê°œ`;
    }
    }


    document.getElementById("orderForm").addEventListener("input", calculateTotal);
    document.getElementById("orderForm").addEventListener("change", calculateTotal);

    // í•™ìƒ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    async function fetchStudent() {
      const studentId = document.getElementById("studentIdInput").value;
      if (!studentId) {
        alert("í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      try {
        const res = await fetch(`/api/student/${studentId}`);
        if (!res.ok) throw new Error("ì¡°íšŒ ì‹¤íŒ¨");
        const data = await res.json();

        // ìë™ ì±„ìš°ê¸°
        document.getElementById("name").value = data.name;
        document.getElementById("department").value = data.department;
        document.getElementById("gender").value = data.gender;
        document.getElementById("payment").value = data.payment === "ë‚©ë¶€ì" ? "true" : "false";
        document.getElementById("status").value = data.status;

        // ì´ ê°€ê²© ì¬ê³„ì‚°
        calculateTotal();

        alert("í•™ìƒ ì •ë³´ê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } catch (err) {
        console.error(err);
        alert("í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // ì£¼ë¬¸ ì œì¶œ
    document.getElementById("orderForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const isPaid = formData.get("payment") === "true";

    const order = {
    studentId: formData.get("studentId"),
    í•™ê³¼: formData.get("department"),
    name: formData.get("name"),
    gender: formData.get("gender"),
    payment: isPaid,
    status: formData.get("status"),
    items: [],
    totalPrice: parseInt(totalPriceEl.dataset.raw), // âœ… ì½¤ë§ˆ ì—†ëŠ” ìˆ«ì
    timestamp: new Date().toISOString()
    };


      PRODUCTS.forEach((p, i) => {
        const count = parseInt(formData.get(`product${i}`)) || 0;
        if (count > 0) {
          order.items.push({
            name: p.name,
            count,
            unitPrice: isPaid ? p.pricePaid : p.priceUnpaid,
            category: p.category
          });
        }
      });

      await fetch("/api/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(order)
      });

      alert("ì£¼ë¬¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
      location.reload(); // ìƒˆë¡œê³ ì¹¨
    });

    function handleExternal() {
    const isExternal = document.getElementById("externalCheck").checked;

    const studentId = document.getElementById("studentIdInput");
    const name = document.getElementById("name");
    const department = document.getElementById("department");
    const gender = document.getElementById("gender");
    const payment = document.getElementById("payment");
    const status = document.getElementById("status");

    if (isExternal) {
        // ì…ë ¥ ê°’ ê³ ì •
        studentId.value = "ì™¸ë¶€ì¸";
        name.value = "ì™¸ë¶€ì¸";
        department.value = "ì™¸ë¶€ì¸";
        payment.innerHTML = `<option value="ì™¸ë¶€ì¸">ì™¸ë¶€ì¸</option>`;
        status.value = "ì™¸ë¶€ì¸";

        // ìˆ˜ì • ë¶ˆê°€ ì²˜ë¦¬
        studentId.readOnly = true;
        name.readOnly = true;
        department.readOnly = true;
        payment.disabled = true;
        status.readOnly = true;
    } else {
        // ì…ë ¥ê°’ ì´ˆê¸°í™”
        studentId.value = "";
        name.value = "";
        department.value = "";
        payment.disabled = false;
        payment.innerHTML = `
        <option value="true">ë‚©ë¶€ì</option>
        <option value="false">ë¯¸ë‚©ë¶€ì</option>
        `;
        status.value = "";

        // ë‹¤ì‹œ ìˆ˜ì • ê°€ëŠ¥
        studentId.readOnly = false;
        name.readOnly = false;
        department.readOnly = false;
        payment.disabled = false;
        status.readOnly = false;
    }

    calculateTotal();
    }


    function resetForm() {
    document.getElementById("externalCheck").checked = false;

    const studentId = document.getElementById("studentIdInput");
    const name = document.getElementById("name");
    const department = document.getElementById("department");
    const gender = document.getElementById("gender");
    const payment = document.getElementById("payment");
    const status = document.getElementById("status");

    studentId.value = "";
    name.value = "";
    department.value = "";
    status.value = "";

    studentId.readOnly = false;
    name.readOnly = true;
    department.readOnly = true;
    gender.disabled = true;
    payment.disabled = true;

    gender.value = "ë‚¨";
    payment.innerHTML = `
        <option value="true">ë‚©ë¶€ì</option>
        <option value="false">ë¯¸ë‚©ë¶€ì</option>
    `;

    PRODUCTS.forEach((_, i) => {
        document.querySelector(`[name="product${i}"]`).value = 0;
    });

    // âœ… ì´ ê°€ê²© ì½¤ë§ˆ í¬í•¨ ì´ˆê¸°í™”
    document.getElementById("totalPrice").textContent = (0).toLocaleString();
    document.getElementById("totalPrice").dataset.raw = 0;

    }

    async function loadAcrylicEventTotal() {
        try {
            const res = await fetch("/api/acrylic-event-count");
            const data = await res.json();
            document.getElementById("acrylicEventTotal").textContent =
            `ëˆ„ì  ì´ë²¤íŠ¸ ìˆ˜ëŸ‰: ${data.acrylicEventTotal}ê°œ`;
        } catch (err) {
            console.error("ì´ë²¤íŠ¸ ìˆ˜ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨:", err);
            document.getElementById("acrylicEventTotal").textContent =
            "ëˆ„ì  ì´ë²¤íŠ¸ ìˆ˜ëŸ‰: ì˜¤ë¥˜";
        }
    }

    loadAcrylicEventTotal(); // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜¸ì¶œ



  </script>
</body>
</html>
